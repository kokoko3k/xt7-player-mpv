' Gambas class file

'Copyright (C) 2007, 2008 Antonio Orefice
' Gambas class file

Public xbindkeys As Process
Public AlreadyLoaded As Boolean = False 'true if the form loaded it's settings from disk at least one time

Private predefined_hotkeys_number As Integer = 91

Private customize_me_msg As String = ("Click me to customize")

Public Sub xbindkeys_read()
  Dim comando As String
  Line Input #xbindkeys, comando
    global.myDebug("Remote Command = " & comando)

    Select Case Lower(comando)
      Case "start play"
        FMain.ButtonStop_Click()
        FMain.ButtonPlay_Click()
      Case "play/pause"
        'IF NOT FMain.mplayer.ProcessRunningOvr() THEN FMain.ButtonPlay_Click()
        FMain.ButtonPlay_Click()
      Case "stop"
        FMain.ButtonStop_Click()
      Case "next track"
        FMain.SelectNext(False, FMain.GetActivePlayQueue())
      Case "previous track"
        FMain.ButtonPrev_Click()
      Case "seek +10sec"
        FMain.mplayer.do_seek_by("+10", FsForm.fullscreen)
      Case "seek -10sec"
        FMain.mplayer.do_seek_by("-10", FsForm.fullscreen)
      Case "volume +"
        fmain.volume_add("+2")
      Case "volume -"
        fmain.volume_add("-2")
      Case "mute/unmute"
        FMain.mplayer.Send("cycle mute")
    End Select
End

Private already_filled As Boolean = False

Private Sub FillGridHeaders(Optional force As Boolean = False)
  Dim r, c As Integer
  If (already_filled And (Not force)) Then Return
  already_filled = True
  'fixmempv
  'Local Hotkeys#####################################
  HotKeysGrid.header = GridView.Horizontal
  HotKeysGrid.Columns.count = 6
  HotKeysGrid.rows.count = 130
  
  For r = 0 To HotKeysGrid.rows.count - 1
    HotKeysGrid[r, 0].WordWrap = True
  Next
  
  HotKeysGrid.Columns[0].text = "Action"
  HotKeysGrid.Columns[1].text = "HotKey 1"
  HotKeysGrid.Columns[2].text = "HotKey 2"
  HotKeysGrid.Columns[3].text = "HotKey 3"
  HotKeysGrid.Columns[4].text = "HotKey 4"
  HotKeysGrid.Columns[5].text = "HotKey 5"
  
  HotKeysGrid[0, 0].text = "switch fullscreen"
  HotKeysGrid[1, 0].text = "pause"
  HotKeysGrid[2, 0].text = " "
  HotKeysGrid[3, 0].text = "volume +1"
  HotKeysGrid[4, 0].text = "volume -1"
  HotKeysGrid[5, 0].text = "add balance +0.1"
  HotKeysGrid[6, 0].text = "add balance -0.1"
  HotKeysGrid[7, 0].text = "cycle mute"
  HotKeysGrid[8, 0].text = " "
  HotKeysGrid[9, 0].text = "seek +10"
  HotKeysGrid[10, 0].text = "seek -10"
  HotKeysGrid[11, 0].text = "seek +60"
  HotKeysGrid[12, 0].text = "seek -60"
  HotKeysGrid[13, 0].text = "seek +600"
  HotKeysGrid[14, 0].text = "seek -600"
  HotKeysGrid[15, 0].text = " "
  HotKeysGrid[16, 0].text = "add chapter +1"
  HotKeysGrid[17, 0].text = "add chapter -1"
  HotKeysGrid[18, 0].text = " "
  HotKeysGrid[19, 0].text = "frame-back-step"
  HotKeysGrid[20, 0].text = "frame-step"
  HotKeysGrid[21, 0].text = " "
  HotKeysGrid[22, 0].text = "set speed 1"
  HotKeysGrid[23, 0].text = "multiply speed 1.1"
  HotKeysGrid[24, 0].text = "multiply speed 0.9"
  HotKeysGrid[25, 0].text = "add speed +0.01"
  HotKeysGrid[26, 0].text = "add speed -0.01"
  HotKeysGrid[27, 0].text = " "
  HotKeysGrid[28, 0].text = "zoom +0.05"
  HotKeysGrid[29, 0].text = "zoom -0.05"
  HotKeysGrid[30, 0].text = " "
  HotKeysGrid[31, 0].text = "set video-aspect 4:3"
  HotKeysGrid[32, 0].text = "set video-aspect 16:9"
  HotKeysGrid[33, 0].text = "set video-aspect 16:10"
  HotKeysGrid[34, 0].text = "set video-aspect 2.35:1"
  HotKeysGrid[35, 0].text = "set video-aspect 1:1"
  HotKeysGrid[36, 0].text = "add video-aspect +0.05"
  HotKeysGrid[37, 0].text = "add video-aspect -0.05"
  HotKeysGrid[38, 0].text = " "
  HotKeysGrid[39, 0].text = "set video-rotate 0"
  HotKeysGrid[40, 0].text = "cycle-values video-rotate 90 180 270 0"
  HotKeysGrid[41, 0].text = " "
  HotKeysGrid[42, 0].text = " "
  HotKeysGrid[43, 0].text = "contrast +1"
  HotKeysGrid[44, 0].text = "contrast -1"
  HotKeysGrid[45, 0].text = "gamma +1"
  HotKeysGrid[46, 0].text = "gamma -1"
  HotKeysGrid[47, 0].text = "brightness +1"
  HotKeysGrid[48, 0].text = "brightness -1"
  HotKeysGrid[49, 0].text = "hue +1"
  HotKeysGrid[50, 0].text = "hue -1"
  HotKeysGrid[51, 0].text = "saturation +1"
  HotKeysGrid[52, 0].text = "saturation -1"
  HotKeysGrid[53, 0].text = " "
  HotKeysGrid[54, 0].text = "cycle audio"
  HotKeysGrid[55, 0].text = "add audio-delay +0.1"
  HotKeysGrid[56, 0].text = "add audio-delay -0.1"
  HotKeysGrid[57, 0].text = " "
  HotKeysGrid[58, 0].text = "cycle sub"
  HotKeysGrid[59, 0].text = "cycle subvisibility"
  HotKeysGrid[60, 0].text = "add sub-delay +0.1"
  HotKeysGrid[61, 0].text = "add sub-delay -0.1"
  HotKeysGrid[62, 0].text = "add sub-scale +0.1"
  HotKeysGrid[63, 0].text = "add sub-scale -0.1"
  HotKeysGrid[64, 0].text = "add sub-pos +5"
  HotKeysGrid[65, 0].text = "add sub-pos -5"
  HotKeysGrid[66, 0].text = "sub-reload"
  HotKeysGrid[67, 0].text = " "
  HotKeysGrid[68, 0].text = "cycle deinterlace"
  HotKeysGrid[69, 0].text = "cycle framedrop"
  HotKeysGrid[70, 0].text = " "
  HotKeysGrid[71, 0].text = "cycle tv-norm"
  HotKeysGrid[72, 0].text = "add tv-channel +1"
  HotKeysGrid[73, 0].text = "add tv-channel -1"
  HotKeysGrid[74, 0].text = "add tv-brightness +5"
  HotKeysGrid[75, 0].text = "add tv-brightness  -5"
  HotKeysGrid[76, 0].text = "add tv-contrast +5"
  HotKeysGrid[77, 0].text = "add tv-contrast -5"
  HotKeysGrid[78, 0].text = "add tv-hue +5"
  HotKeysGrid[79, 0].text = "add tv-hue -5"
  HotKeysGrid[80, 0].text = "add tv-saturation +5"
  HotKeysGrid[81, 0].text = "add tv-saturation -5"
  HotKeysGrid[82, 0].text = " "
  HotKeysGrid[83, 0].text = "cycle vid"
  HotKeysGrid[84, 0].text = "delete current file"
  HotKeysGrid[85, 0].text = "osd-level"
  HotKeysGrid[86, 0].text = "screenshot"
  HotKeysGrid[87, 0].text = "quit"
  HotKeysGrid[88, 0].text = " "
  HotKeysGrid[89, 0].text = "show runtime infos"

  For r = predefined_hotkeys_number - 1 To predefined_hotkeys_number 
    HotKeysGrid[r, 1].text = " "
  Next 'r

  For r = predefined_hotkeys_number To HotKeysGrid.Rows.count - 1
    HotKeysGrid[r, 0].text = customize_me_msg
  Next 'r
  
  For r = 0 To HotKeysGrid.Rows.count - 1
    HotKeysGrid[r, 0].Background = Color.ButtonBackground
    HotKeysGrid[r, 0].Font.Bold = True
    If r Mod 2 = 0 Then
      For c = 1 To HotKeysGrid.Columns.count - 1
        HotKeysGrid[r, c].background = Global.Alternatecolor
      Next 'c
    Endif
  Next 'r
  
 
  
  'Global Hotkeys #######################################################
  
  GlobalHotKeysGrid.Columns.count = 5
  GlobalHotKeysGrid.rows.count = 20
  GlobalHotKeysGrid.Columns[0].text = "HotKey 1"
  GlobalHotKeysGrid.Columns[1].text = "HotKey 2"
  GlobalHotKeysGrid.Columns[2].text = "HotKey 3"
  GlobalHotKeysGrid.Columns[3].text = "HotKey 4"
  GlobalHotKeysGrid.Columns[4].text = "HotKey 5"
  
  GlobalHotKeysGrid.Rows[0].text = "start play"
  GlobalHotKeysGrid.Rows[1].text = "play/pause"
  GlobalHotKeysGrid.Rows[2].text = "stop"
  GlobalHotKeysGrid.Rows[3].text = "next track"
  GlobalHotKeysGrid.Rows[4].text = "previous track"
  GlobalHotKeysGrid.Rows[5].text = "seek +10sec"
  GlobalHotKeysGrid.Rows[6].text = "seek -10sec"
  GlobalHotKeysGrid.Rows[7].text = "volume +"
  GlobalHotKeysGrid.Rows[8].text = "volume -"
  GlobalHotKeysGrid.Rows[9].text = "mute/unmute"

  For r = 10 To GlobalHotKeysGrid.Rows.count - 1
    GlobalHotKeysGrid.Rows[r].text = "For future use"
  Next 'r

  For r = 0 To GlobalHotKeysGrid.Rows.count - 1
    If r Mod 2 = 0 Then
      For c = 0 To GlobalHotKeysGrid.Columns.count - 1
        GlobalHotKeysGrid[r, c].background = Global.Alternatecolor
      Next 'c
    Endif
  Next 'r
  

  ' gambas to mpv translation grid **********************
  
  

  gridtranslate.columns.count = 3
  gridtranslate.rows.count = 100
  gridtranslate.Header = GridView.horizontal
  gridtranslate.Columns[0].text = ("xt7 hotkey")
  gridtranslate.Columns[1].text = ("mpv hotkey")
  gridtranslate.Columns[2].text = ("Comment")
  gridtranslate.Columns[0].w = gridtranslate.Font.TextWidth("12345678901234567890123456789")
  gridtranslate.Columns[1].w = gridtranslate.Font.TextWidth("12345678901234567890123456789")
  
End

Private Sub DefaultFill()
  Dim r, c As Integer
  'clear grid
    For r = 0 To HotKeysGrid.Rows.count - 1
      For c = 1 To HotKeysGrid.Columns.count - 1
        HotKeysGrid[r, c].Text = ""
      Next
    Next
  HotKeysGrid[0, 1].text = "Mouse=0 Wheel=NONE Key=f"
  HotKeysGrid[0, 2].text = "Mouse=4 Wheel=NONE Key="
  HotKeysGrid[1, 1].text = "Mouse=0 Wheel=NONE Key=p"
  HotKeysGrid[1, 2].text = "Mouse=1 Wheel=NONE Key="
  HotKeysGrid[1, 3].text = "Mouse=0 Wheel=NONE Key=space"
  HotKeysGrid[3, 1].text = "Mouse=0 Wheel=NONE Key=+"
  HotKeysGrid[3, 2].text = "Mouse=0 Wheel=UP Key="
  HotKeysGrid[4, 1].text = "Mouse=0 Wheel=NONE Key=-"
  HotKeysGrid[4, 2].text = "Mouse=0 Wheel=DOWN Key="
  HotKeysGrid[7, 1].text = "Mouse=0 Wheel=NONE Key=m"
  HotKeysGrid[9, 1].text = "Mouse=0 Wheel=NONE Key=right"
  HotKeysGrid[9, 2].text = "Mouse=1 Wheel=UP Key="
  HotKeysGrid[10, 1].text = "Mouse=0 Wheel=NONE Key=left"
  HotKeysGrid[10, 2].text = "Mouse=1 Wheel=DOWN Key="
  HotKeysGrid[11, 1].text = "Mouse=0 Wheel=NONE Key=up"
  HotKeysGrid[11, 2].text = "Mouse=3 Wheel=UP Key="
  HotKeysGrid[12, 1].text = "Mouse=0 Wheel=NONE Key=down"
  HotKeysGrid[12, 2].text = "Mouse=3 Wheel=DOWN Key="
  HotKeysGrid[23, 1].text = "Mouse=0 Wheel=NONE Key=]"
  HotKeysGrid[24, 1].text = "Mouse=0 Wheel=NONE Key=["
  HotKeysGrid[28, 1].text = "Mouse=0 Wheel=NONE Key=e"
  HotKeysGrid[28, 2].text = "Mouse=2 Wheel=UP Key="
  HotKeysGrid[29, 1].text = "Mouse=0 Wheel=NONE Key=w"
  HotKeysGrid[29, 2].text = "Mouse=2 Wheel=DOWN Key="
  HotKeysGrid[31, 1].text = "Mouse=0 Wheel=NONE Key=f1"
  HotKeysGrid[32, 1].text = "Mouse=0 Wheel=NONE Key=f2"
  HotKeysGrid[33, 1].text = "Mouse=0 Wheel=NONE Key=f3"
  HotKeysGrid[34, 1].text = "Mouse=0 Wheel=NONE Key=f4"
  HotKeysGrid[35, 1].text = "Mouse=0 Wheel=NONE Key=f5"
  HotKeysGrid[36, 1].text = "Mouse=0 Wheel=NONE Key=f6"
  HotKeysGrid[37, 1].text = "Mouse=0 Wheel=NONE Key=f7"
  HotKeysGrid[39, 1].text = "Mouse=0 Wheel=NONE Mod=Ctrl Key=r"
  HotKeysGrid[40, 1].text = "Mouse=0 Wheel=NONE Key=r"
  HotKeysGrid[41, 1].text = "Mouse=0 Wheel=NONE Mod=Shift Key=r"
  HotKeysGrid[43, 1].text = "Mouse=0 Wheel=NONE Mod=Shift Key=c"
  HotKeysGrid[44, 1].text = "Mouse=0 Wheel=NONE Key=c"
  HotKeysGrid[45, 1].text = "Mouse=0 Wheel=NONE Mod=Shift Key=g"
  HotKeysGrid[46, 1].text = "Mouse=0 Wheel=NONE Key=g"
  HotKeysGrid[47, 1].text = "Mouse=0 Wheel=NONE Mod=Shift Key=b"
  HotKeysGrid[48, 1].text = "Mouse=0 Wheel=NONE Key=b"
  HotKeysGrid[49, 1].text = "Mouse=0 Wheel=NONE Mod=Shift Key=h"
  HotKeysGrid[50, 1].text = "Mouse=0 Wheel=NONE Key=h"
  HotKeysGrid[51, 1].text = "Mouse=0 Wheel=NONE Mod=Shift Key=s"
  HotKeysGrid[52, 1].text = "Mouse=0 Wheel=NONE Key=s"
  HotKeysGrid[54, 1].text = "Mouse=0 Wheel=NONE Key=a"
  HotKeysGrid[55, 1].text = "Mouse=0 Wheel=NONE Key=."
  HotKeysGrid[56, 1].text = "Mouse=0 Wheel=NONE Key=,"
  HotKeysGrid[60, 1].text = "Mouse=0 Wheel=NONE Mod=Shift Key=:"
  HotKeysGrid[61, 1].text = "Mouse=0 Wheel=NONE Mod=Shift Key=;"
  HotKeysGrid[62, 1].text = "Mouse=0 Wheel=NONE Mod=Shift Key=t"
  HotKeysGrid[63, 1].text = "Mouse=0 Wheel=NONE Key=t"
  HotKeysGrid[64, 1].text = "Mouse=0 Wheel=NONE Mod=CtrlShift Key=t"
  HotKeysGrid[65, 1].text = "Mouse=0 Wheel=NONE Mod=Ctrl Key=t"
  HotKeysGrid[68, 1].text = "Mouse=0 Wheel=NONE Mod=Shift Key=d"
  HotKeysGrid[84, 1].text = "Mouse=0 Wheel=NONE Mod=Shift Key=del"
  HotKeysGrid[85, 1].text = "Mouse=0 Wheel=NONE Key=o"
  HotKeysGrid[85, 2].text = "Mouse=2 Wheel=NONE Key="
  HotKeysGrid[87, 1].text = "Mouse=0 Wheel=NONE Key=esc"
  HotKeysGrid[89, 1].text = "Mouse=0 Wheel=NONE Mod=Shift Key=backspace"

End

Private Function Grab_mpv() As String
  HotKeyGrabmpv.show
  'ME.hide
  Repeat
    Wait 0.1
  Until HotKeyGrabmpv.visible = False
  Return HotKeyGrabmpv.hotkey_out
End


Private Function Grab() As String
  HotKeyGrab.show
  'ME.hide
  Repeat
    Wait 0.1
  Until HotKeyGrab.visible = False
  Return HotKeyGrab.AllGrabbedData()
End

Private Function GlobalGrab() As String
  Dim xbindkeys_output As String
  Dim outputS As String[]
  Dim hotkey, g As String
  Dim x, y, w, h As Integer

  w = Me.Font.TextWidth("_") * 50
  h = Me.Font.textheight("|") * 10
  x = Me.screenx + (Me.w Div 2) - (w Div 2)
  y = Me.screeny + (Me.h Div 2) - (h Div 2)
  g = " -g " & w & "x" & h & "+" & x & "+" & y & " " 
  
  Shell "touch /tmp/xbindkeysrc" Wait
  Shell Global.XbindkeysBIN & g & " -k -f /tmp/xbindkeysrc" To xbindkeys_output
  outputS = Split(xbindkeys_output, "\n", "", True)
  hotkey = Trim(outputS[outputS.count - 1])
  Return hotkey
End


Public initialized As Boolean = False

Public Sub init()
  Try FillGridHeaders()
  If Not Error Then initialized = True
End

Public Sub FirstLoadIfNeeded()
  If Not initialized Then init()
  If Not AlreadyLoaded Then 
      MenuLoadDefault_Click()
  Endif
End


Public Sub Form_Open()
  FirstLoadIfNeeded()
  Global.Center(Fmain, Me)
  Try FillGridHeaders()
End

Private Function CheckDuplicate(Hotkey As String, RowSrc As Integer, ColSrc As Integer, MyGrid As Gridview) As Boolean
  Dim C, R As Integer

  Dim FoundDupe As Boolean = False
  Dim DupedFunction As String
  Dim Answer As Integer
  For c = 0 To MyGrid.Columns.Count - 1
    For r = 0 To MyGrid.Rows.Count - 1
      If MyGrid[r, c].text = Hotkey Then
        FoundDupe = True
        Break
      Endif
      If FoundDupe Then Break
    Next 'r
    If FoundDupe Then Break
  Next 'c

  If FoundDupe And (Not ((R = RowSrc) And (C = ColSrc))) Then
    If MyGrid.header = GridView.both Then 
      DupedFunction = MyGrid.rows[r].Text
        Else
      DupedFunction = MyGrid[r, 0].Text
    Endif
    Answer = Message.Warning(("The hotkey you entered is already defined for ") & DupedFunction, ("Delete old "), ("Delete new "), ("Assign nevertheless"))
    Select Case Answer
      Case 1 'delete old
        MyGrid[r, c].text = ""
        Return True
      Case 2 'delete new
        Return False
      Case 3 'Assign nevertheless
        Return True
      Case 0 'No answer
        Return False
    End Select
      Else
    Return True
  Endif
End

Private Function MouseInsideGrid(Librarygrid As Gridview) As Boolean
  With LibraryGrid
   If (Mouse.screeny > .screeny + .Columns.Height + 1) And (Mouse.screeny < .screeny + .clientH + .Columns.Height + 1) Then
     If (Mouse.screenX < .screenx + .ClientW) Then
       Return True
     Endif
   Endif
 End With
 Return False
End

Public Sub HotKeysGrid_DblClick()
  handle_new_xt7_hotkey(hotkeysgrid)
End

Public Sub gridtranslate_DblClick()
  If Last.column = 0 Then handle_new_xt7_hotkey(gridtranslate)
  If Last.column = 1 Then handle_new_mpv_hotkey(gridtranslate)
  If Last.column = 2 Then Last[Last.row, Last.column].text = MyAskName.Ask(("Type a comment"), "", True)
End


Public Sub handle_new_mpv_hotkey(g As Gridview)

  Dim PointedRow As Integer = g.row
  Dim PointedCol As Integer = g.Column
  Dim GrabbedData As String
  Dim w1, w2 As Integer = 0

  If pointedcol = -1 Then Return
  If pointedrow = -1 Then Return


  If MouseInsideGrid(g) Then
    GrabbedData = Grab_mpv()
    'Insert Grabbed Data into a cell, discard if no Data is received (eg: shift pressed)
        g[pointedrow, PointedCol].Text = GrabbedData
    
    'Expand the column
    w1 = g.Columns[PointedCol].width
    ' [GB2:FNTW] w2 = HotKeysGrid.Font.TextWidth(HotKeysGrid[pointedrow, PointedCol].Text)
    w2 = g.Font.TextWidth(g[pointedrow, PointedCol].Text)
    If w1 < w2 Then
      g.Columns[PointedCol].width = w2 + 8
    Endif
  Endif
  
End




Public Sub handle_new_xt7_hotkey(g As Gridview)

  Dim PointedRow As Integer = g.row
  Dim PointedCol As Integer = g.Column
  Dim GrabbedData As String
  Dim w1, w2 As Integer = 0

  If pointedcol = -1 Then Return
  If pointedrow = -1 Then Return
  If (pointedcol = 0) And g <> gridtranslate Then 
    action_click(pointedrow)
    Return
  Endif

  If MouseInsideGrid(g) Then
    GrabbedData = Grab()
    'Insert Grabbed Data into a cell, discard if no Data is received (eg: shift pressed)
    If Not (GrabbedData = "Mouse=0 Wheel=NONE Key= **") Then
      If CheckDuplicate(GrabbedData, g.row, g.Column, g) Then
        g[pointedrow, PointedCol].Text = GrabbedData
      Endif
    Endif
    
    'Expand the column
    w1 = g.Columns[PointedCol].width
    ' [GB2:FNTW] w2 = HotKeysGrid.Font.TextWidth(HotKeysGrid[pointedrow, PointedCol].Text)
    w2 = g.Font.TextWidth(g[pointedrow, PointedCol].Text)
    If w1 < w2 Then
      g.Columns[PointedCol].width = w2 + 8
    Endif
  Endif
  
End


Public Sub handle_grid_keypress(g As Gridview)
  Dim PointedRow As Integer = g.row
  Dim PointedCol As Integer = g.Column  
  
  If Key.code = Key.delete Then
    If (pointedcol > 0) Or (g = gridtranslate) Then
      g[pointedrow, PointedCol].text = ""
        Else 
      If g = hotkeysgrid Then
        If pointedrow >= (predefined_hotkeys_number) Then
          g[pointedrow, PointedCol].text = customize_me_msg
        Endif
      Endif
    Endif
  Endif 
End


Public Sub HotKeysGrid_KeyPress()
  handle_grid_keypress(hotkeysgrid)
End

Public Sub gridtranslate_KeyPress()
  handle_grid_keypress(gridtranslate)
End


Public Sub SaveHotKeys(ProfileName As String)
  'DIM filename AS String = ProfileName & "." & "HotKeys.txt"
  Dim filename As String = ProfileName & ".profile/" & "HotKeys.txt"
  Dim filename_v2 As String = ProfileName & ".profile/" & "HotKeys_v2.txt"
  Dim filename_fs As String = ProfileName & ".profile/" & "HotKeys_fs.txt"
  Dim filename_global_hk As String = ProfileName & ".profile/" & "HotKeys_global_enabled.txt"
  Dim filename_translation As String = ProfileName & ".profile/" & "HotKeyTranslation.txt"
  Dim globalfilename As String = ProfileName & ".profile/" & "GlobalHotKeys.txt"
  Dim xbindkeysfilename As String = ProfileName & ".profile/" & "xbindkeysrc"
  Dim HotFile As File
  Dim globalhotfile As File
  Dim C, R As Integer
  Dim local_data As String

  If dblclick_fs_checkbox.value Then
    File.Save(filename_fs, "TRUE")
      Else
    File.Save(filename_fs, "FALSE")
  Endif
  If CheckBoxEnableGlobalHotkeys.value Then
    File.Save(filename_global_hk, "TRUE")
      Else
    File.Save(filename_global_hk, "FALSE")
  Endif

  If Not Exist(file.Dir(filename), True) Then
    Try Mkdir File.dir(File.Dir(File.dir(File.Dir(File.Dir(filename)))))
    Try Mkdir File.Dir(File.dir(File.Dir(File.Dir(filename))))
    Try Mkdir File.dir(File.Dir(File.Dir(filename)))
    Try Mkdir File.Dir(File.Dir(filename))
    Try Mkdir File.Dir(filename)
  Endif
  
  ' 'local hotkeys
  ' HotFile = Open filename For Write Create
  ' For c = 0 To HotKeysGrid.Columns.Count - 1
  '   For r = 0 To predefined_hotkeys_number - 1
  '     'PRINT c & "," & r
  '     Write #HotFile, HotKeysGrid[R, C].text As String
  '   Next 'r
  ' Next 'c
  ' Close #HotFile

  For r = 0 To HotKeysGrid.Rows.count - 1
    For c = 0 To HotKeysGrid.Columns.Count - 1
      local_data &= "\n" & r & Chr(8) & c & Chr(8) & HotKeysGrid[r, c].text  
    Next
  Next
  File.Save(filename_v2, local_data)

  local_data = ""
  For r = 0 To gridtranslate.Rows.count - 1
    For c = 0 To gridtranslate.Columns.Count - 1
      local_data &= "\n" & r & Chr(8) & c & Chr(8) & gridtranslate[r, c].text  
    Next
  Next
  File.Save(filename_translation, local_data)
  
  
  'global hotkeys
    'xbindkeys configuration file
    UpdateXbindKeysConfigurationFile(ProfileName & ".profile/" & "xbindkeysrc")
    'stringgrid file
    GlobalHotFile = Open Globalfilename For Write Create
    For c = 0 To GlobalHotKeysGrid.Columns.Count - 1
      For r = 0 To GlobalHotKeysGrid.Rows.Count - 1
        'PRINT c & "," & r
        Write #GlobalHotFile, GlobalHotKeysGrid[R, C].text As String
      Next 'r
    Next 'c
    Close #GlobalHotFile
    RestartXbindKeys(xbindkeysfilename)
End

Public Sub UpdateXbindKeysConfigurationFile(xbindkeysfilename As String)
'will "dump" globalhotkeys grid into xbindkeys file format.
 Dim xbindkeysFile As File
 Dim c, r As Integer
    xbindkeysFile = Open xbindkeysfilename For Write Create
    For c = 0 To GlobalHotKeysGrid.Columns.Count - 1
      For r = 0 To GlobalHotKeysGrid.Rows.Count - 1
        If (Trim(GlobalHotKeysGrid[r, c].text) <> "") Then
          Print #xbindkeysFile, " \"echo '" & GlobalHotKeysGrid.Rows[r].Text & "'\""
          Print #xbindkeysFile, GlobalHotKeysGrid[R, C].text
          Print #xbindkeysFile, "\n"
        Endif
      Next 'r
    Next 'c
    Close #xbindkeysFile
End

Public Sub LoadHotKeys(ProfileName As String)
  Dim filename As String = ProfileName & ".profile/" & "HotKeys.txt"
  Dim filename_v2 As String = ProfileName & ".profile/" & "HotKeys_v2.txt"
  Dim filename_fs As String = ProfileName & ".profile/" & "HotKeys_fs.txt"
  Dim filename_global_hk As String = ProfileName & ".profile/" & "HotKeys_global_enabled.txt"
  Dim filename_translation As String = ProfileName & ".profile/" & "HotKeyTranslation.txt"
  Dim Globalfilename As String = ProfileName & ".profile/" & "GlobalHotKeys.txt"
  Dim xbindkeysfilename As String = ProfileName & ".profile/" & "xbindkeysrc"
  Dim HotFile As File
  Dim GlobalHotFile As File
  Dim local_data As String
  Dim sRow, t As String
  Dim aRow As String[]
  Dim need_defaults As Boolean = True

  Dim c, r, w1, w2 As Integer

  If Exist(filename_fs, True) Then
    Try dblclick_fs_checkbox.value = (File.Load(filename_fs) = "TRUE")
      Else
    dblclick_fs_checkbox.value = True 'default value
  Endif
  If Exist(filename_global_hk, True) Then
    Try checkboxenableglobalhotkeys.value = (File.Load(filename_global_hk) = "TRUE")
      Else
    checkboxenableglobalhotkeys.value = False 'default value
  Endif
  
  
  'DefaultFill()
  For c = 1 To HotKeysGrid.Columns.Count - 1
     HotKeysGrid.Columns[c].w = -1
  Next

  HotKeysGrid.Columns[0].Width = HotKeysGrid.Font.TextWidth("______________________________")
  

  'Local Hotkeys, try to load new format, first.
  If Exist(filename_v2, True) Then
    need_defaults = False
    For Each sRow In Split(File.Load(filename_v2), "\n", "", True, False)
      Try aRow = Split(sRow, "," & Chr(8), "", False)
      If aRow.count > 2 Then 
        c = aRow[1]
        r = aRow[0]
        t = aRow[2]
        If c = 0 Then 
          If (r > 89) Then HotKeysGrid[r, c].text = Right(sRow, -Len(CStr(c)) - Len(CStr(r)) - 2)
            Else
          HotKeysGrid[r, c].text = t
        Endif
      Endif
    Next
      Else
    If Exist(filename, True) Then 
      need_defaults = False
      If Stat(filename, True).size > 0 Then
          HotFile = Open filename For Read
          For c = 1 To HotKeysGrid.Columns.Count - 1
            For r = 0 To 91
              HotKeysGrid[R, C].text = Read #HotFile As String
              'Expand the column
              w1 = HotKeysGrid.Columns[c].width
              ' [GB2:FNTW] w2 = HotKeysGrid.Font.TextWidth(HotKeysGrid[r, c].Text)
              w2 = HotKeysGrid.Font.TextWidth(HotKeysGrid[r, c].Text)
              If w1 < w2 Then
                HotKeysGrid.Columns[c].width = w2 + 8
              Endif
            Next 'r
          Next 'c
          Close #HotFile
      Endif
    Endif
  Endif
  
  'load xt7 to mpv translation hotkeys
  If Exist(filename_translation, True) Then
    For Each sRow In Split(File.Load(filename_translation), "\n", "", True, False)
      Try aRow = Split(sRow, "," & Chr(8), "", False)
      If aRow.count > 2 Then 
        r = aRow[0]
        c = aRow[1]
        t = aRow[2]
        gridtranslate[r, c].text = t
      Endif
    Next
  Endif
  
  If need_defaults Then DefaultFill()
  
  'Global Hotkeys grid:
   If Exist(filename, True) Then 
    If Stat(filename, True).size > 0 Then
      GlobalHotFile = Open Globalfilename For Read
      For c = 0 To GlobalHotKeysGrid.Columns.Count - 1
        For r = 0 To GlobalHotKeysGrid.Rows.Count - 1
          GlobalHotKeysGrid[R, C].text = Read #GlobalHotFile As String
          'Expand the column
          w1 = GlobalHotKeysGrid.Columns[c].width
          ' [GB2:FNTW] w2 = GlobalHotKeysGrid.Font.TextWidth(GlobalHotKeysGrid[r, c].Text)
          w2 = GlobalHotKeysGrid.Font.TextWidth(GlobalHotKeysGrid[r, c].Text)
          If w1 < w2 Then
            GlobalHotKeysGrid.Columns[c].width = w2 + 8
          Endif
        Next 'r
      Next 'c
      Close #GlobalHotFile
    Endif
   Endif
   RestartXbindKeys(xbindkeysfilename)
 
End

Public Sub RestartXbindKeys(xbindkeysfilename As String)
  If (checkboxenableglobalhotkeys.value = checkboxenableglobalhotkeys.true) Then 
    If FMain.closing Then Return
    global.myDebug("Hotkeys: RestartXbindKeys()")
    Try xbindkeys.Kill
    If Exist(xbindkeysfilename, True)
      If Stat(xbindkeysfilename).Size > 0 Then
        xbindkeys = Shell Global.XbindkeysBIN & " -n -f " & xbindkeysfilename For Read As "xbindkeys"
      Endif
    Endif
  Endif
End


' PUBLIC SUB ApplyBTN_Click()
'   TRY SaveHotKeys("/tmp/hotkeys.txt")
'   TRY LoadHotKeys("/tmp/hotkeys.txt")
' END

Public Sub ApplyBTN_Click()
  Dim tmpfile As String = Temp("HotKeys.txt")
  Try SaveHotKeys(tmpfile)
  Try LoadHotKeys(tmpfile)
End

Public Sub OkBTN_Click()
  Me.HIDE
End

Public Function ActionRelatedTo(Hotkey As String) As String
'will find the cell containing 'Hotkey' in Hotkeys grid
'will return the related action
  Dim c, r As Integer

  ' If FMain.timerdvd.enabled Then
  '   If Lower(Split(Hotkey, " ")[0]) = "mouse=1" Then Return "discnav select"
  ' Endif
  If hotkey = "" Then Return "Nope"
    For c = 1 To HotKeysGrid.Columns.Count - 1
      For r = 0 To HotKeysGrid.Rows.Count - 1
        If (HotKeysGrid[r, c].text = Hotkey) Then Return HotKeysGrid[r, 0].text
      Next 'r
    Next 'c
  Return "Nope" 'no hotkey found
End




Public Sub MenuSaveDefault_Click()
  Try HotKeys.SaveHotKeys(global.confpath & "/" & Global.CurrentProfile)
End


Public Sub MenuSaveToAll_Click()
Dim profilename, profilenamesplitted As String
  If MyQuestion.Ask(("This will save this window settings\n to all profiles found but the 'Factory_defaults' one"), ("Proceed"), ("Don't")) = 2 Then
    Return
      Else
     For Each profilename In Dir(global.confpath & "/", "*.profile")
        If Stat(global.confpath & "/" & profilename, True).type = gb.Directory Then
          profilenamesplitted = Split(profilename, ".")[0]
          If profilenamesplitted <> "Factory_Defaults" Then
            Try HotKeys.SaveHotKeys(global.confpath & "/" & profilenamesplitted)
          Endif
        Endif
     Next 'profilename
  Endif
End

Public Sub MenuLoadDefault_Click()
  Try HotKeys.LoadHotKeys(global.confpath & "/" & Global.CurrentProfile)
  If Not Error Then Alreadyloaded = True
End

Public Sub Button1_Click()
  DefaultFill()
End

Public Sub Button2_Click()
  Dim r, c As Integer
  For r = 0 To HotKeysGrid.Rows.Count - 1
    For c = 1 To HotKeysGrid.columns.Count - 1
        HotKeysGrid[r, c].text = ""
    Next 'c
  Next 'r
End

Public Sub Button3_Click()
  Dim r, c As Integer
  For r = 0 To HotKeysGrid.Rows.Count - 1
    For c = 0 To HotKeysGrid.columns.Count - 1
      If Trim(HotKeysGrid[r, c].text) <> "" Then
        Print "HotKeysGrid[" & r & " , " & c & "].text = " & "\"" & HotKeysGrid[r, c].text & "\""
      Endif
    Next 'c
  Next 'r
End


Public Sub GlobalHotKeysGrid_DblClick()
  Dim PointedRow As Integer = GlobalHotKeysGrid.row
  Dim PointedCol As Integer = GlobalHotKeysGrid.Column
  Dim GrabbedData As String
  Dim w1, w2 As Integer = 0
  Dim profilename As String

  If Not Last.enabled Then Return

  If MouseInsideGrid(GlobalHotKeysGrid) Then
    GlobalHotKeysGrid.mouse = Mouse.wait
    Try xbindkeys.Kill
    GrabbedData = GlobalGrab()
    GlobalHotKeysGrid.mouse = Mouse.Default
    If Not (GrabbedData Like "*bind*") Then
      If CheckDuplicate(GrabbedData, GlobalHotKeysGrid.row, GlobalHotKeysGrid.Column, GlobalHotKeysGrid) Then
        GlobalHotKeysGrid[pointedrow, PointedCol].Text = GrabbedData
      Endif
    Endif
   
    'Expand the column
    Try w1 = GlobalHotKeysGrid.Columns[PointedCol].width
    ' [GB2:FNTW] w2 = GlobalHotKeysGrid.Font.TextWidth(GlobalHotKeysGrid[pointedrow, PointedCol].Text)
    If Not Error Then
      w2 = GlobalHotKeysGrid.Font.TextWidth(GlobalHotKeysGrid[pointedrow, PointedCol].Text)
      If w1 < w2 Then
        GlobalHotKeysGrid.Columns[PointedCol].width = w2 + 8
      Endif
    Endif
  Endif
  
  'refresh current xbindkeys process and make it use a temporary profile,
  'so, first dump temporary global hotkeys to a temporary file
  Profilename = global.confpath & "/" & Global.CurrentProfile
  UpdateXbindKeysConfigurationFile(ProfileName & ".profile/" & "xbindkeysrc.tmp")
  RestartXbindKeys(ProfileName & ".profile/" & "xbindkeysrc.tmp")
End

Public Sub GlobalHotKeysGrid_KeyPress()
  Dim PointedRow As Integer = GlobalHotKeysGrid.row
  Dim PointedCol As Integer = GlobalHotKeysGrid.Column
  Dim profilename As String
  If Key.code = Key.delete Then
    GlobalHotKeysGrid[pointedrow, PointedCol].text = ""
    'refresh current xbindkeys process and make it use a temporary profile,
    'so, first dump temporary global hotkeys to a temporary file
    Try xbindkeys.Kill
    Profilename = global.confpath & "/" & Global.CurrentProfile
    UpdateXbindKeysConfigurationFile(ProfileName & ".profile/" & "xbindkeysrc.tmp")
    RestartXbindKeys(ProfileName & ".profile/" & "xbindkeysrc.tmp")
  Endif

End

Public Sub Button4_Click()
  Dim r, c As Integer
  For r = 0 To GlobalHotKeysGrid.Rows.Count - 1
    For c = 0 To GlobalHotKeysGrid.columns.Count - 1
        GlobalHotKeysGrid[r, c].text = ""
    Next 'c
  Next 'r
End

Public Sub Form_Close()

  If FMain.mplayer.ProcessRunningOvr() Then fmain.videoboxproxy.SetFocus()

End

Public Sub Form_Hide()

  If FMain.mplayer.ProcessRunningOvr() Then fmain.videoboxproxy.SetFocus()

End

Public Sub SaveBTN_Click()

   Try HotKeys.SaveHotKeys(global.confpath & "/" & Global.CurrentProfile)

End



Public Sub Form_Show()
  Try Object.SetProperty(HotKeysGrid, "ShowCursor", True)
  HotKeysGrid.Rows.H = CInt(HotKeysGrid.Font.TextHeight("Ij|") * 1.5)
  GlobalHotKeysGrid.H = CInt(GlobalHotKeysGrid.Font.TextHeight("Ij|") * 1.5)
End

Public Function checkxbindkeys() As Boolean
  If Not global.Which("xbindkeys") Then 
    Message.Error(("Sorry, could not find xbindkeys"), "Ok")
    Return False
      Else
    Return True
  Endif
End


Public Sub Panel2_Arrange()
   If Not fmain.fullyloaded Then Return
   globalhotkeysgrid.visible = (checkboxenableglobalhotkeys.value = checkboxenableglobalhotkeys.true)
   Wait
   GlobalHotKeysGrid.Move(0, 0, Panel2.clientw, Panel2.clienth)
End

Public Sub CheckBoxEnableGlobalHotkeys_Click()
  Dim profilename As String
  Wait
  If Not fmain.fullyloaded Then Return
  If checkboxenableglobalhotkeys.value = CheckBox.true Then 
    If checkxbindkeys() Then
      globalhotkeysgrid.visible = checkxbindkeys()
      Profilename = global.confpath & "/" & Global.CurrentProfile
      RestartXbindKeys(ProfileName & ".profile/" & "xbindkeysrc.tmp")
        Else
      checkboxenableglobalhotkeys.value = CheckBox.false
    Endif
      Else
    globalhotkeysgrid.visible = False
    Try xbindkeys.Kill
  Endif

End


Public Sub TabStrip1_Click()
  If TabStrip1.Children[0] = CheckBoxEnableGlobalHotkeys Then
   If checkboxenableglobalhotkeys.value = CheckBox.true Then checkxbindkeys()
  Endif
End

Public Sub action_click(Row As Integer)
  Dim r As Integer = HotKeysGrid.row
  Dim newvalue As String
  Dim last_text As String = HotKeysGrid[r, 0].text
  If row < predefined_hotkeys_number Then Return
  
  newvalue = MyAskName.Ask(("Type an mpv input command"), HotKeysGrid[r, 0].text, True)
  If newvalue = "" Then 
    HotKeysGrid[r, 0].text = last_text
      Else
    HotKeysGrid[r, 0].text = newvalue
  Endif
  HotKeysGrid.Refresh
End


Public Sub Button5_Click()

  FillGridHeaders(True)  

End
